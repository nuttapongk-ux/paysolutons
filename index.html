<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Control - Batch User Creation</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Checkbox Custom Style */
        .custom-checkbox:checked + div {
            background-color: #eff6ff; /* blue-50 */
            border-color: #4f46e5; /* indigo-600 */
            color: #4338ca; /* indigo-700 */
        }
        .custom-checkbox:checked + div .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        .user-card-enter {
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .highlight-row {
            animation: highlightPulse 1.5s ease-out;
        }
        @keyframes highlightPulse {
            0% { background-color: #e0e7ff; } 
            100% { background-color: white; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <!-- Navbar / Toggle View -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button onclick="toggleView('user')" id="btnUserView" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg hover:bg-indigo-700 transition-colors hidden">
            <i class="fa-solid fa-pen-to-square mr-2"></i> หน้าฟอร์มคำร้อง
        </button>
        <button onclick="toggleView('admin')" id="btnAdminView" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg hover:bg-slate-700 transition-colors">
            <i class="fa-solid fa-user-shield mr-2"></i> ระบบจัดการหลังบ้าน (Admin)
        </button>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden p-8 relative">
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg ring-4 ring-slate-100">
                    <i class="fa-solid fa-user-shield text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">Admin Access</h3>
                <p class="text-sm text-slate-500 mt-1">เข้าสู่ระบบเพื่อจัดการข้อมูล</p>
            </div>
            <form onsubmit="handleAdminLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Username</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-user"></i></span>
                        <input type="text" id="loginUsername" class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm transition-all" placeholder="Enter username">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Password</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-slate-400"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="loginPassword" class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm transition-all" placeholder="Enter password">
                    </div>
                </div>
                <div id="loginError" class="text-red-500 text-xs text-center hidden bg-red-50 py-2 rounded border border-red-100">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง
                </div>
                <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-medium py-2.5 rounded-lg shadow-lg shadow-slate-200 transition-all active:scale-[0.98] mt-2">
                    เข้าสู่ระบบ
                </button>
                <div class="text-center mt-4 space-y-1">
                    <span class="text-[10px] text-slate-400 block">Default Login (หากยังไม่สร้าง user):</span>
                    <div class="text-[10px] text-slate-400">Admin: admin / 1234</div>
                    <div class="text-[10px] text-slate-400">Sale: sale / 1234</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin User Management Modal -->
    <div id="adminUsersModal" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="fa-solid fa-users-gear text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-lg">จัดการผู้ใช้ระบบ (Back Office Users)</h3>
                        <p class="text-xs text-slate-400">เพิ่มลบผู้ใช้งานที่สามารถเข้าสู่ระบบหลังบ้านได้</p>
                    </div>
                </div>
                <button onclick="closeAdminUsersModal()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto bg-white flex flex-col">
                <!-- Add User Form -->
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3"><i class="fa-solid fa-user-plus mr-1"></i> เพิ่มผู้ใช้งานใหม่</h4>
                    <form id="addAdminUserForm" onsubmit="saveAdminUser(event)" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="hidden" id="adminUserId"> <!-- Hidden ID for Edit -->
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Username</label>
                            <input type="text" id="adminUsername" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:border-indigo-500 outline-none" placeholder="เช่น admin">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Password</label>
                            <input type="text" id="adminPassword" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:border-indigo-500 outline-none" placeholder="รหัสผ่าน">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Display Name</label>
                            <input type="text" id="adminDisplayName" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:border-indigo-500 outline-none" placeholder="เช่น Super Admin">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Role (สิทธิ์)</label>
                            <select id="adminRole" class="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:border-indigo-500 outline-none bg-white">
                                <option value="admin">Admin (Full Access)</option>
                                <option value="sale">Sale (Read Only)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                            <button type="button" onclick="resetAdminUserForm()" class="px-3 py-2 text-xs text-slate-500 hover:text-slate-700">ล้างค่า</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded text-xs hover:bg-indigo-700 shadow-sm flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> บันทึกข้อมูล
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Users List -->
                <div class="flex-1 overflow-y-auto border border-slate-200 rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-600 font-medium text-xs uppercase sticky top-0">
                            <tr>
                                <th class="px-4 py-3">User</th>
                                <th class="px-4 py-3">Name</th>
                                <th class="px-4 py-3">Role</th>
                                <th class="px-4 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTable" class="divide-y divide-slate-100">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-end gap-3">
                <button onclick="closeAdminUsersModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 text-sm font-medium">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- Role Settings Modal -->
    <div id="roleSettingsModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="fa-solid fa-user-tag text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-lg">จัดการบทบาท (Role Management)</h3>
                        <p class="text-xs text-slate-400">กำหนดเมนูเริ่มต้นสำหรับแต่ละบทบาท</p>
                    </div>
                </div>
                <button onclick="closeRoleSettingsModal()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
                <!-- Role Selector Sidebar -->
                <div class="w-full md:w-64 bg-slate-50 border-r border-slate-200 p-4 shrink-0 flex flex-col">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">เลือกบทบาท (Select Role)</h4>
                    <div id="settingsRoleList" class="space-y-2 flex-1 overflow-y-auto pr-1">
                        <!-- Role items generated by JS -->
                    </div>
                    
                    <!-- Add New Role Section -->
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-2 block">เพิ่มบทบาทใหม่ (New Role)</label>
                        <div class="flex gap-2">
                            <input type="text" id="newRoleNameInput" placeholder="ระบุชื่อ Role..." class="flex-1 px-3 py-2 text-xs border border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
                            <button onclick="addNewRole()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs hover:bg-indigo-700 transition-colors shadow-sm">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Checkbox Area -->
                <div class="flex-1 p-6 overflow-y-auto bg-white">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                        <h4 class="text-sm font-bold text-slate-800" id="currentRoleTitle">Editing: Manager</h4>
                        <div class="flex gap-2">
                            <button type="button" onclick="toggleSettingsAll(true)" class="text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">เลือกทั้งหมด</button>
                            <button type="button" onclick="toggleSettingsAll(false)" class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">ล้าง</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs" id="roleSettingsGrid">
                        <!-- Checkboxes generated by JS -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-end gap-3">
                <button onclick="closeRoleSettingsModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 text-sm font-medium">ปิดหน้าต่าง</button>
                <button id="btnSaveRoleSettings" onclick="saveRoleSettings()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> บันทึกค่าเริ่มต้น
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Settings Modal -->
    <div id="menuSettingsModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="fa-solid fa-list-check text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-lg">จัดการรายการเมนู (Menu Management)</h3>
                        <p class="text-xs text-slate-400">แก้ไข ID, ชื่อเมนู และกำหนดสถานะบังคับ (Required)</p>
                    </div>
                </div>
                <button onclick="closeMenuSettingsModal()" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto bg-white flex flex-col">
                <div class="bg-yellow-50 text-yellow-800 px-3 py-2 rounded-md text-xs mb-4 border border-yellow-100 flex items-start gap-2">
                    <i class="fa-solid fa-circle-info mt-0.5"></i>
                    <div>
                        <strong>คำแนะนำ:</strong> <br>
                        - <strong>เมนูหลัก</strong> สามารถเลือกได้ว่าจะบังคับ (Required) หรือไม่<br>
                        - <strong>แดชบอร์ด</strong> (ID 15) ถูกบังคับให้เป็น Required เสมอ
                    </div>
                </div>
                
                <!-- Add Menu -->
                <div class="flex gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200 items-end flex-wrap">
                    <div class="w-16">
                        <label class="text-[10px] text-slate-500 block mb-1">ID</label>
                        <input type="number" id="newMenuId" placeholder="Auto" class="w-full px-2 py-2 text-xs border border-slate-300 rounded outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="text-[10px] text-slate-500 block mb-1">ชื่อเมนู (Menu Name)</label>
                        <input type="text" id="newMenuName" placeholder="ระบุชื่อเมนู..." class="w-full px-3 py-2 text-xs border border-slate-300 rounded outline-none focus:border-indigo-500">
                    </div>
                    <div class="w-40">
                        <label class="text-[10px] text-slate-500 block mb-1">หมวดหมู่ (Parent)</label>
                        <select id="newMenuParent" onchange="toggleMandatoryCheck()" class="w-full px-2 py-2 text-xs border border-slate-300 rounded outline-none focus:border-indigo-500 bg-white">
                            <option value="">- เป็นเมนูหลัก -</option>
                            <!-- Generated by JS -->
                        </select>
                    </div>
                    <div class="flex items-center justify-center pb-2 px-2" id="newMenuMandatoryContainer">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="newMenuMandatory" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <span class="text-xs text-slate-600 select-none">Required</span>
                        </label>
                    </div>
                    <button onclick="addNewMenu()" class="bg-emerald-600 text-white px-4 py-2 rounded text-xs hover:bg-emerald-700 flex items-center gap-2 h-[34px]">
                        <i class="fa-solid fa-plus"></i> เพิ่ม
                    </button>
                </div>

                <!-- Menu List -->
                <div class="flex-1 overflow-y-auto border border-slate-200 rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-600 font-medium text-xs uppercase sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 w-24 text-center">ID</th>
                                <th class="px-4 py-3">ชื่อเมนู (Menu Name)</th>
                                <th class="px-4 py-3 w-32">หมวดหมู่</th>
                                <th class="px-4 py-3 w-20 text-center">Req.</th>
                                <th class="px-4 py-3 text-right w-24">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="menuManagerTable" class="divide-y divide-slate-100">
                            <!-- Menus generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-end gap-3">
                <button onclick="closeMenuSettingsModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 text-sm font-medium">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal (Unified) -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center transform transition-all scale-100">
            <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                <i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">ยืนยันการลบ?</h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed">
                คุณต้องการลบ "<span id="deleteItemNameDisplay" class="font-bold text-slate-700"></span>" ใช่หรือไม่?<br>
                <span class="text-xs text-red-400">* การกระทำนี้ไม่สามารถเรียกคืนได้</span>
            </p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeDeleteConfirmModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 text-sm font-medium transition-colors">
                    ยกเลิก
                </button>
                <button id="btnConfirmDelete" class="px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium shadow-md shadow-red-100 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> ยืนยันลบ
                </button>
            </div>
        </div>
    </div>

    <!-- Detail Modal (Admin) -->
    <div id="detailModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg">
                        <i class="fa-solid fa-file-invoice text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg" id="modalMerchantName">Merchant Name</h3>
                        <p class="text-xs text-slate-400" id="modalBatchId">Batch ID: -</p>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-0 overflow-y-auto flex-1 bg-slate-50">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200 sticky top-0 shadow-sm z-10">
                        <tr>
                            <th class="px-6 py-3 font-semibold w-[25%]">User Info</th>
                            <th class="px-6 py-3 font-semibold w-[15%]">Role</th>
                            <th class="px-6 py-3 font-semibold w-[35%]">Permissions (Menus)</th>
                            <th class="px-6 py-3 font-semibold w-[10%] text-center">Status</th>
                            <th class="px-6 py-3 font-semibold w-[15%] text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody" class="divide-y divide-slate-100 bg-white">
                        <!-- Content injected by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-between items-center">
                <button onclick="exportBatchExcel()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm transition-colors">
                    <i class="fa-solid fa-file-excel"></i> Export Excel
                </button>
                <button onclick="closeDetailModal()" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 font-medium text-sm">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal (New) -->
    <div id="editUserModal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-user-pen mr-2"></i>แก้ไขข้อมูลผู้ใช้งาน</h3>
                <button onclick="closeEditModal()" class="text-indigo-200 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                <form id="editUserForm" class="space-y-4">
                    <input type="hidden" id="editUserId">
                    
                    <!-- Basic Info -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">ข้อมูลส่วนตัว</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-slate-700 mb-1">Username</label>
                                <input type="text" id="editName" class="w-full px-3 py-2 rounded border border-slate-300 text-sm focus:border-indigo-500 outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-medium text-slate-700 mb-1">อีเมล</label>
                                <input type="email" id="editEmail" class="w-full px-3 py-2 rounded border border-slate-300 text-sm focus:border-indigo-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Role & Permissions -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">สิทธิ์การใช้งาน</h4>
                        
                        <div class="mb-4">
                            <label class="block text-xs font-medium text-slate-700 mb-2">บทบาท (Role)</label>
                            <div id="editRoleGrid" class="grid grid-cols-4 gap-2">
                                <!-- Generated by JS -->
                            </div>
                        </div>

                        <div class="border-t border-slate-100 pt-3">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-medium text-slate-700">เลือกเมนูรายตัว</label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="toggleEditAll(true)" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-1 rounded">เลือกทั้งหมด</button>
                                    <button type="button" onclick="toggleEditAll(false)" class="text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded">ล้าง</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs" id="editPermissionGrid">
                                <!-- Generated JS -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 text-sm font-medium">ยกเลิก</button>
                <button onclick="saveUserChanges()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow-sm">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg"><i class="fa-solid fa-magnifying-glass-chart text-xl"></i></div>
                    <h3 class="font-bold text-lg">ตรวจสอบข้อมูลก่อนส่ง (Preview Request)</h3>
                </div>
                <button onclick="closePreviewModal()" class="text-indigo-200 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50 custom-scrollbar">
                <div class="bg-white p-4 rounded-lg border border-slate-200 mb-6 shadow-sm">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">ข้อมูลร้านค้า (Merchant Info)</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-slate-500 block text-xs">Merchant ID</span> <span id="previewMerchantId" class="font-medium text-slate-800 text-lg">-</span></div>
                        <div><span class="text-slate-500 block text-xs">Merchant Name</span> <span id="previewMerchantName" class="font-medium text-slate-800 text-lg">-</span></div>
                    </div>
                </div>
                <div class="flex justify-between items-end mb-3">
                    <h4 class="text-sm font-bold text-slate-700">รายการผู้ใช้งานที่จะสร้าง (<span id="previewUserCount">0</span>)</h4>
                </div>
                <div id="previewUserList" class="space-y-3"></div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-white shrink-0 flex justify-end gap-3">
                <button onclick="closePreviewModal()" class="px-6 py-2.5 border border-slate-300 text-slate-600 font-medium rounded-lg hover:bg-slate-50 hover:text-slate-800 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-pen-to-square"></i> กลับไปแก้ไข
                </button>
                <button onclick="confirmSubmission()" id="confirmSubmitBtn" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-lg shadow-indigo-200 transition-all active:scale-[0.98] flex items-center gap-2">
                    <span>ยืนยันการส่งข้อมูล</span> <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Container Center Wrapper -->
    <div class="flex items-center justify-center min-h-[calc(100vh-2rem)]">

        <!-- ================= USER VIEW: REQUEST FORM ================= -->
        <div id="userView" class="bg-white rounded-2xl shadow-xl w-full max-w-6xl overflow-hidden flex flex-col md:flex-row min-h-[600px] animate-fade-in">
            <!-- Sidebar / Info Section -->
            <div class="bg-indigo-600 p-8 md:w-1/4 flex flex-col justify-between text-white relative overflow-hidden shrink-0">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                    <i class="fa-solid fa-store absolute -right-10 -bottom-10 text-9xl transform -rotate-12"></i>
                    <i class="fa-solid fa-users absolute top-10 -left-10 text-8xl transform rotate-12"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-white/20 p-2 rounded-lg">
                            <i class="fa-solid fa-layer-group text-2xl"></i>
                        </div>
                        <span class="font-bold text-xl tracking-wide">Merchant Control</span>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">เพิ่มผู้ใช้งาน (Batch)</h2>
                    <p class="text-indigo-100 font-light text-sm leading-relaxed">
                        สามารถเพิ่มผู้ใช้งานได้หลายคนในครั้งเดียว โดยใช้ข้อมูลร้านค้าชุดเดียวกัน
                    </p>
                    <div class="mt-6 bg-indigo-800/50 p-4 rounded-lg backdrop-blur-sm border border-indigo-500/30">
                        <div class="text-xs text-indigo-200 mb-1 uppercase tracking-wider font-semibold">รายการที่เพิ่มแล้ว</div>
                        <div class="text-3xl font-bold text-white flex items-baseline gap-2">
                            <span id="queueCountDisplay">0</span>
                            <span class="text-sm font-normal opacity-70">คน</span>
                        </div>
                    </div>
                </div>
                <div class="relative z-10 mt-8 md:mt-0">
                    <div class="space-y-4 text-xs text-indigo-100">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-user-plus mt-1"></i>
                            <span>กด "เพิ่มลงรายการ" เพื่อสะสมรายชื่อ</span>
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-paper-plane mt-1"></i>
                            <span>กด "ยืนยันทั้งหมด" เพื่อส่งคำร้องทีเดียว</span>
                        </div>
                    </div>
                    <p class="text-[10px] mt-8 opacity-60">&copy; 2024 Merchant Systems Inc.</p>
                </div>
            </div>

            <!-- Form Section -->
            <div class="p-8 md:w-3/4 relative flex flex-col h-[90vh] md:h-auto">
                <div id="successMessage" class="hidden absolute inset-0 z-50 flex-col items-center justify-center animate-fade-in bg-slate-900/40 backdrop-blur-[2px]">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center mx-4 border border-slate-100 transform scale-100">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-5 mx-auto ring-4 ring-green-50">
                            <i class="fa-solid fa-check text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-3">ได้รับข้อมูลเรียบร้อยแล้ว</h3>
                        <p class="text-slate-600 mb-6 text-sm leading-relaxed">
                            ทาง <span class="font-semibold text-indigo-600">Paysolutions</span> ได้รับข้อมูลของท่านแล้ว<br>
                            โดยจะดำเนินการให้ภายใน 24 ชั่วโมง
                        </p>
                        <button onclick="resetAll()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-medium py-3 px-4 rounded-xl transition-all shadow-lg shadow-slate-200 active:scale-[0.98]">
                            ปิดหน้าจอ
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800">สร้างผู้ใช้งานใหม่ (Create Users)</h3>
                    </div>
                </div>

                <form id="requestForm" class="flex-1 overflow-y-auto pr-2 pb-24 scroll-smooth">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 sticky top-0 z-20 shadow-sm">
                         <h4 class="text-sm font-semibold text-slate-500 mb-3 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-shop text-indigo-500"></i> ข้อมูลร้านค้า (ใช้ร่วมกัน)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-700 mb-1">รหัสร้านค้า (ID)</label>
                                <input type="text" name="merchantId" required placeholder="M-xxxxxx" class="w-full px-3 py-2 rounded border border-slate-300 focus:border-indigo-500 focus:outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-700 mb-1">ชื่อร้านค้า</label>
                                <input type="text" name="merchantName" placeholder="ระบุชื่อร้านค้า" class="w-full px-3 py-2 rounded border border-slate-300 focus:border-indigo-500 focus:outline-none text-sm bg-white">
                            </div>
                        </div>
                    </div>

                    <div id="queueSection" class="hidden mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-users-viewfinder text-indigo-600"></i> รายการที่รอส่ง (Pending List)
                        </h4>
                        <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-2">Username</th>
                                        <th class="px-4 py-2">Role</th>
                                        <th class="px-4 py-2 text-center">สิทธิ์</th>
                                        <th class="px-4 py-2 text-right">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody id="queueListBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="border-2 border-dashed border-indigo-200 bg-indigo-50/30 p-5 rounded-xl mb-4 relative transition-all" id="userInputSection">
                        <div class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-indigo-600 border border-indigo-100 rounded-full shadow-sm">
                            <i class="fa-solid fa-user-plus mr-1"></i> เพิ่มผู้ใช้งานคนที่ <span id="nextUserIndex">1</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 mt-2">
                            <div>
                                <label class="block text-xs font-medium text-slate-700 mb-1">Username <span class="text-red-500">*</span></label>
                                <input type="text" id="inputName" placeholder="ระบุ Username" class="w-full px-3 py-2 rounded border border-slate-300 focus:border-indigo-500 focus:outline-none text-sm bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-700 mb-1">อีเมล <span class="text-red-500">*</span></label>
                                <input type="email" id="inputEmail" placeholder="email@ex.com" class="w-full px-3 py-2 rounded border border-slate-300 focus:border-indigo-500 focus:outline-none text-sm bg-white">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-xs font-medium text-slate-700 mb-2">บทบาท (Role)</label>
                            <div id="mainRoleGrid" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                        <details class="group bg-white rounded-lg border border-slate-200" open>
                            <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-3 text-xs text-slate-600 bg-slate-50 rounded-t-lg group-open:border-b">
                                <span><i class="fa-solid fa-list-check mr-2 text-indigo-500"></i> กำหนดสิทธิ์รายเมนู (Advanced)</span>
                                <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <div class="text-neutral-600 p-3 group-open:animate-fadeIn">
                                <div class="flex justify-end gap-2 mb-2">
                                    <button type="button" onclick="toggleAll(true)" class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-1 rounded">เลือกทั้งหมด</button>
                                    <button type="button" onclick="toggleAll(false)" class="text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded">ล้าง</button>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs" id="permissionGrid"></div>
                            </div>
                        </details>
                        <div class="mt-4 flex justify-end">
                            <button type="button" onclick="addToQueue()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-lg transition-all active:scale-95">
                                <i class="fa-solid fa-plus-circle"></i> เพิ่มลงรายการ
                            </button>
                        </div>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-slate-200 flex items-center justify-between z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <div class="text-sm text-slate-500 hidden sm:block">
                            รอส่งทั้งหมด <span id="footerCount" class="font-bold text-slate-800">0</span> รายการ
                        </div>
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <button type="button" onclick="resetAll()" class="px-4 py-2.5 border border-slate-300 text-slate-600 font-medium rounded-lg hover:bg-slate-50 transition-colors bg-white flex-1 sm:flex-none">
                                ล้างทั้งหมด
                            </button>
                            <button type="submit" id="submitAllBtn" disabled class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-2.5 px-6 rounded-lg shadow-lg shadow-indigo-200 transition-all flex justify-center items-center gap-2">
                                <span>ยืนยันทั้งหมด</span>
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ================= ADMIN VIEW ================= -->
        <div id="adminView" class="bg-white rounded-2xl shadow-xl w-full max-w-6xl overflow-hidden hidden flex-col min-h-[600px] animate-fade-in">
             <div class="bg-slate-800 text-white p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 p-3 rounded-xl">
                        <i class="fa-solid fa-users-gear text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Admin Management</h2>
                        <div class="flex items-center gap-2">
                            <p class="text-slate-400 text-sm">ระบบจัดการคำร้องขอเปิดใช้งาน</p>
                            <span id="currentUserBadge" class="bg-indigo-500 text-[10px] px-2 py-0.5 rounded-full text-white font-bold uppercase hidden"></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Admin Only Buttons -->
                    <div id="adminTools" class="flex gap-3 hidden">
                        <button onclick="openRoleSettingsModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-600 flex items-center gap-2 shadow-sm">
                            <i class="fa-solid fa-user-tag mr-1"></i> ตั้งค่าบทบาท
                        </button>
                        <button onclick="openMenuSettingsModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-600 flex items-center gap-2 shadow-sm">
                            <i class="fa-solid fa-list mr-1"></i> จัดการเมนู
                        </button>
                        <button onclick="openAdminUsersModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-600 flex items-center gap-2 shadow-sm">
                            <i class="fa-solid fa-users-gear mr-1"></i> ผู้ใช้ระบบ
                        </button>
                    </div>
                    
                    <button onclick="handleLogout()" class="bg-red-500/20 text-red-100 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-red-500/30 flex items-center gap-2">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex gap-3">
                <div class="relative flex-1 max-w-sm">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="adminSearchInput" onkeyup="window.searchRequests()" placeholder="ค้นหาชื่อ, Merchant ID, Batch ID..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:border-indigo-500">
                </div>
                <div class="flex gap-2">
                    <div class="bg-white px-4 py-2 rounded-lg border border-slate-300 text-xs font-medium text-slate-600">
                        Users รออนุมัติ: <span id="pendingCount" class="font-bold text-yellow-500">0</span>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-lg border border-slate-300 text-xs font-medium text-slate-600">
                        Users อนุมัติแล้ว: <span id="approvedCount" class="font-bold text-green-500">0</span>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-x-auto p-4">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-sm border-y border-slate-200">
                            <th class="p-4 font-semibold w-32">วันที่แจ้ง</th>
                            <th class="p-4 font-semibold">ร้านค้า (Merchant ID / Name)</th>
                            <th class="p-4 font-semibold text-center">จำนวน Users</th>
                            <th class="p-4 font-semibold text-center">สถานะ</th>
                            <th class="p-4 font-semibold text-right">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody id="requestTableBody" class="text-sm text-slate-700 divide-y divide-slate-100"></tbody>
                </table>
                <div id="emptyState" class="hidden flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fa-solid fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p>ยังไม่มีรายการคำร้องขอ</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp, query, orderBy, setDoc, getDoc, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfal6grNtLApn1oiX8p0mbyb4TpsMYrDo",
            authDomain: "gloy-8831a.firebaseapp.com",
            databaseURL: "https://gloy-8831a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gloy-8831a",
            storageBucket: "gloy-8831a.firebasestorage.app",
            messagingSenderId: "920776916154",
            appId: "1:920776916154:web:eef1247abf4e1d77c89683",
            measurementId: "G-34F6XB9S9T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'merchant-control-demo';

        // --- AUTH ---
        signInAnonymously(auth).catch((error) => {
            console.error("Auth Error", error);
        });

        // --- GLOBAL HELPERS (Moved to top to prevent ReferenceError) ---
        async function saveRolesToFirebase() {
            try {
                const rolesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings_roles', 'default');
                await setDoc(rolesDocRef, { roles: rolePermissions });
            } catch (error) {
                console.error("Error saving roles:", error);
            }
        }

        async function saveMenusToFirebase() {
            try {
                const menusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings_menus', 'default');
                await setDoc(menusDocRef, { items: menuItems });
            } catch (error) {
                console.error("Error saving menus:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกเมนู");
            }
        }

        // --- HELPER FOR PERMISSION LOGIC (Fixing cleanPermissions) ---
        function cleanPermissions(permissions) {
            let permissionSet = new Set(permissions);
            
            // Find parents with children
            const parents = menuItems.filter(m => m.type === 'header');
            
            parents.forEach(parent => {
                const children = menuItems.filter(m => m.parentId === parent.id);
                if (children.length > 0) {
                    // Check if ANY child is selected
                    const hasChildSelected = children.some(child => permissionSet.has(child.id));
                    
                    if (!hasChildSelected) {
                        // Condition: If no sub-menu selected, Main Menu = 0 (Remove Parent)
                        permissionSet.delete(parent.id);
                    } else {
                        // Optional: If child selected, ensure Parent is 1? 
                        // Usually yes, but for now we follow the "remove if no child" rule strictly.
                        // If you want auto-add parent: permissionSet.add(parent.id);
                        permissionSet.add(parent.id); // Assuming parent is needed to view children
                    }
                }
            });

            // Ensure mandatory are kept
            menuItems.forEach(m => {
                if (m.mandatory) permissionSet.add(m.id);
            });

            return Array.from(permissionSet);
        }

        // --- NEW FUNCTION: Auto-select/Deselect Parent based on Child state ---
        window.handlePermissionChange = function(checkbox) {
            const id = parseInt(checkbox.value);
            const item = menuItems.find(m => m.id === id);
            const groupName = checkbox.name; // permissions, editPermissions, settingsPermissions

            if (item && item.parentId) {
                // It's a sub menu, handle parent sync
                const parentId = item.parentId;
                
                // Find parent checkbox in the same group
                const parentCb = document.querySelector(`input[name="${groupName}"][value="${parentId}"]`);
                
                if (parentCb) {
                    const parentItem = menuItems.find(m => m.id === parentId);
                    
                    if (checkbox.checked) {
                        // Case 1: Select Child -> Auto Select Parent
                        parentCb.checked = true;
                    } else {
                        // Case 2: Deselect Child -> Check if any siblings remain checked
                        if (!parentItem.mandatory) {
                            const siblings = menuItems.filter(m => m.parentId === parentId);
                            let anySiblingChecked = false;
                            
                            for (const sibling of siblings) {
                                const siblingCb = document.querySelector(`input[name="${groupName}"][value="${sibling.id}"]`);
                                if (siblingCb && siblingCb.checked) {
                                    anySiblingChecked = true;
                                    break;
                                }
                            }
                            
                            // If no siblings checked, auto deselect parent
                            if (!anySiblingChecked) {
                                parentCb.checked = false;
                            }
                        }
                    }
                }
            }
        }

        function getCheckboxHTML(item, name) {
            const isMandatory = item.mandatory || false;
            const isHeader = item.type === 'header';
            const isSub = item.type === 'item';
            
            // Modified Logic: Disable if Mandatory OR if it is a Header (Main Menu)
            let checkedAttr = '';
            if (isMandatory) {
                checkedAttr = 'checked disabled';
            } else if (isHeader) {
                checkedAttr = 'disabled'; // Disable main menu interaction
            }

            const cursorClass = (isMandatory || isHeader) ? 'cursor-not-allowed opacity-90' : 'cursor-pointer';
            
            let containerClass = "flex items-start gap-2 relative group p-1.5 rounded-md hover:bg-slate-50 transition-colors";
            let textClass = "text-xs text-slate-600 group-hover:text-indigo-700 transition-colors";
            let indentClass = "";
            let icon = "";

            if (isHeader) {
                containerClass += " bg-slate-50/50 border border-slate-100 mb-1";
                textClass = "text-xs font-bold text-slate-800";
                if (isMandatory) {
                    icon = '<i class="fa-solid fa-shield-halved text-[10px] ml-1.5 text-emerald-500" title="Main Menu (Required)"></i>';
                }
            } else if (isSub) {
                 indentClass = "pl-6 border-l-2 border-slate-100 ml-1";
            }
            
            // Added onchange="window.handlePermissionChange(this)"
            return `
                <div class="${indentClass}">
                    <label class="${containerClass} ${cursorClass}">
                        <input type="checkbox" name="${name}" value="${item.id}" onchange="window.handlePermissionChange(this)" class="mt-0.5 custom-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${checkedAttr}>
                        <span class="${textClass}">${item.name}${icon}</span>
                    </label>
                </div>
            `;
        }

        // Helper: Sort items Parent -> Children
        function getSortedMenuItems() {
            const sorted = [];
            const headers = menuItems.filter(m => m.type === 'header').sort((a,b) => a.id - b.id);
            const items = menuItems.filter(m => m.type !== 'header'); // Sub items or orphans

            headers.forEach(h => {
                sorted.push(h);
                // Find children
                const children = items.filter(i => i.parentId === h.id).sort((a,b) => a.id - b.id);
                children.forEach(c => sorted.push(c));
            });
            
            // Add orphans (items without valid parent) if any
            const orphans = items.filter(i => !headers.find(h => h.id === i.parentId));
            orphans.forEach(o => sorted.push(o));

            return sorted;
        }

        function renderAllPermissionGrids() {
            const permissionGrid = document.getElementById('permissionGrid');
            const editPermissionGrid = document.getElementById('editPermissionGrid');
            const roleSettingsGrid = document.getElementById('roleSettingsGrid');
            
            if(permissionGrid) permissionGrid.innerHTML = '';
            if(editPermissionGrid) editPermissionGrid.innerHTML = '';
            if(roleSettingsGrid) roleSettingsGrid.innerHTML = '';

            // ADJUST GRID CSS for hierarchy list view
            if(permissionGrid) permissionGrid.className = "flex flex-col gap-1";
            if(editPermissionGrid) editPermissionGrid.className = "flex flex-col gap-1";
            if(roleSettingsGrid) roleSettingsGrid.className = "flex flex-col gap-1";

            // Helper: Sort items Parent -> Children for display
            const sortedItems = getSortedMenuItems();

            sortedItems.forEach(item => {
                if(permissionGrid) {
                    const div = document.createElement('div'); 
                    div.innerHTML = getCheckboxHTML(item, 'permissions');
                    permissionGrid.appendChild(div);
                }
                if(editPermissionGrid) {
                    const div = document.createElement('div'); 
                    div.innerHTML = getCheckboxHTML(item, 'editPermissions');
                    editPermissionGrid.appendChild(div);
                }
                if(roleSettingsGrid) {
                    const div = document.createElement('div'); 
                    div.innerHTML = getCheckboxHTML(item, 'settingsPermissions');
                    roleSettingsGrid.appendChild(div);
                }
            });
        }
        
        // --- ADMIN AUTH STATE & SESSION ---
        let isAdminLoggedIn = false;
        let currentUserRole = null; 
        let adminUsersList = []; 

        // REMOVED: Auto Login from LocalStorage

        // Default Admin Users (Seed if empty)
        const defaultAdminUsers = [
            { username: 'admin', password: '1234', role: 'admin', name: 'Super Admin' },
            { username: 'sale', password: '1234', role: 'sale', name: 'Sale Team' }
        ];

        // --- UPDATED MENU STRUCTURE ---
        const defaultMenuItems = [
            { id: 15, name: "แดชบอร์ด", type: 'header', mandatory: true }, // Only Dashboard is Mandatory
            { id: 23, name: "ยอดรวมรายได้", type: 'header', mandatory: false },
            { id: 41, name: "ประวัติการโอนเงินคืน", type: 'header', mandatory: false },
            { id: 24, name: "รายการสั่งซื้อและผู้ซื้อ", type: 'header', mandatory: false },
            { id: 25, name: "รายการสั่งซื้อทั้งหมด", type: 'item', parentId: 24 },
            { id: 26, name: "คืนเงินหรือยกเลิกรายการ", type: 'item', parentId: 24 },
            { id: 27, name: "อัตราแลกเปลี่ยน", type: 'item', parentId: 24 }
        ];

        let menuItems = [...defaultMenuItems];

        const commonMenus = [15]; 
        
        let rolePermissions = {
            'manager': 'all',
            'accounting': [15, 23, 41, 24, 26, 27],
            'it': [15, 24, 25, 27],
            'staff': [15, 24, 25]
        };

        let userQueue = [];
        let requests = []; 
        let currentModalBatchId = null;
        let editingMenuId = null;

        const requestForm = document.getElementById('requestForm');
        
        const detailModal = document.getElementById('detailModal');
        const modalTableBody = document.getElementById('modalTableBody');
        const modalMerchantName = document.getElementById('modalMerchantName');
        const modalBatchId = document.getElementById('modalBatchId');

        const editUserModal = document.getElementById('editUserModal');
        
        const roleSettingsModal = document.getElementById('roleSettingsModal');
        const roleSettingsGrid = document.getElementById('roleSettingsGrid');
        const settingsRoleList = document.getElementById('settingsRoleList');
        const mainRoleGrid = document.getElementById('mainRoleGrid');
        const editRoleGrid = document.getElementById('editRoleGrid');
        
        const menuSettingsModal = document.getElementById('menuSettingsModal');
        const menuManagerTable = document.getElementById('menuManagerTable');

        const adminUsersModal = document.getElementById('adminUsersModal');
        const adminUsersTable = document.getElementById('adminUsersTable');
        
        let currentSettingsRole = 'manager';
        let editingRoleKey = null; 
        let itemToDelete = null; 
        let deleteType = null; // 'role', 'menu', 'adminUser'

        // --- REALTIME LISTENER ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 1. Requests
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'merchant_requests'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    requests = [];
                    snapshot.forEach((doc) => {
                        requests.push({ id: doc.id, ...doc.data() });
                    });
                    if (isAdminLoggedIn) {
                        renderAdminTable();
                    }
                });

                // 2. Role Settings
                const rolesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings_roles', 'default');
                onSnapshot(rolesDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        rolePermissions = docSnap.data().roles;
                        renderAllRoleUIs();
                        // Refresh settings checkboxes if open
                        if (!roleSettingsModal.classList.contains('hidden') && rolePermissions[currentSettingsRole]) {
                            switchSettingsRole(currentSettingsRole);
                        }
                    } else {
                        saveRolesToFirebase();
                    }
                });

                // 3. Menu Settings (Listener)
                const menusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings_menus', 'default');
                onSnapshot(menusDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const items = docSnap.data().items || [];
                        if (items.length > 0) {
                            menuItems = items;
                            // Sort handling is done in display helpers
                        }
                        renderAllPermissionGrids();
                        if(!menuSettingsModal.classList.contains('hidden')) {
                            renderMenuManagerTable();
                        }
                        if (!roleSettingsModal.classList.contains('hidden') && rolePermissions[currentSettingsRole]) {
                            switchSettingsRole(currentSettingsRole);
                        }
                    } else {
                        saveMenusToFirebase();
                    }
                });

                // 4. Admin Users (Listener + Seeding)
                const usersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'admin_users');
                onSnapshot(usersColRef, (snapshot) => {
                    if (snapshot.empty) {
                        // Seed Default Users
                        defaultAdminUsers.forEach(u => addDoc(usersColRef, u));
                    } else {
                        adminUsersList = [];
                        snapshot.forEach(doc => {
                            adminUsersList.push({ id: doc.id, ...doc.data() });
                        });
                        if(!adminUsersModal.classList.contains('hidden')) {
                            renderAdminUsersTable();
                        }
                    }
                });
            }
        });

        // --- ADMIN USER MANAGEMENT ---
        window.openAdminUsersModal = function() {
            adminUsersModal.classList.remove('hidden');
            renderAdminUsersTable();
            window.resetAdminUserForm();
        }

        window.closeAdminUsersModal = function() {
            adminUsersModal.classList.add('hidden');
        }

        function renderAdminUsersTable() {
            adminUsersTable.innerHTML = '';
            adminUsersList.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0";
                
                let roleBadge = '';
                if(user.role === 'admin') roleBadge = `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold">ADMIN</span>`;
                else roleBadge = `<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-[10px] font-bold">SALE</span>`;

                tr.innerHTML = `
                    <td class="px-4 py-3 text-slate-700 font-medium">${user.username}</td>
                    <td class="px-4 py-3 text-slate-500">${user.name}</td>
                    <td class="px-4 py-3">${roleBadge}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editAdminUser('${user.id}')" class="text-indigo-400 hover:bg-indigo-50 p-1.5 rounded transition-colors mr-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteItem('${user.id}', 'adminUser')" class="text-red-400 hover:bg-red-50 p-1.5 rounded transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                adminUsersTable.appendChild(tr);
            });
        }

        window.saveAdminUser = async function(e) {
            e.preventDefault();
            const id = document.getElementById('adminUserId').value;
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const name = document.getElementById('adminDisplayName').value.trim();
            const role = document.getElementById('adminRole').value;

            if(!username || !password || !name) return;

            const userData = { username, password, name, role };

            try {
                if (id) {
                    // Update
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'admin_users', id), userData);
                } else {
                    // Create (Check duplicate username locally first for UX)
                    if (adminUsersList.some(u => u.username === username)) {
                        alert('Username นี้มีผู้ใช้งานแล้ว');
                        return;
                    }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'admin_users'), userData);
                }
                window.resetAdminUserForm();
            } catch (err) {
                console.error("Error saving user:", err);
                alert("เกิดข้อผิดพลาด");
            }
        }

        window.editAdminUser = function(id) {
            const user = adminUsersList.find(u => u.id === id);
            if(!user) return;
            
            document.getElementById('adminUserId').value = user.id;
            document.getElementById('adminUsername').value = user.username;
            document.getElementById('adminPassword').value = user.password;
            document.getElementById('adminDisplayName').value = user.name;
            document.getElementById('adminRole').value = user.role;
        }

        window.resetAdminUserForm = function() {
            document.getElementById('addAdminUserForm').reset();
            document.getElementById('adminUserId').value = '';
        }

        function renderSettingsSidebar() {
            settingsRoleList.innerHTML = '';
            const roles = Object.keys(rolePermissions);
            
            if (roles.length === 0) {
                settingsRoleList.innerHTML = '<div class="text-xs text-slate-400 text-center py-4">ไม่มีบทบาท</div>';
                return;
            }

            roles.forEach(roleKey => {
                if (roleKey === editingRoleKey) {
                    // Input Mode
                    const container = document.createElement('div');
                    container.className = 'flex items-center gap-1 px-2 py-2 rounded-lg border border-indigo-300 bg-indigo-50 mb-2 shadow-sm animate-fade-in';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
                    input.className = 'flex-1 min-w-0 text-sm border border-slate-300 rounded px-2 py-1 outline-none focus:border-indigo-500 text-slate-700';
                    input.id = 'editRoleInput';
                    input.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); saveEditedRole(roleKey); } if(e.key === 'Escape') cancelEditingRole(); };
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'p-1.5 text-white bg-green-500 hover:bg-green-600 rounded transition-colors';
                    saveBtn.innerHTML = '<i class="fa-solid fa-check text-xs"></i>';
                    saveBtn.onclick = () => saveEditedRole(roleKey);
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'p-1.5 text-slate-500 hover:bg-slate-200 rounded transition-colors';
                    cancelBtn.innerHTML = '<i class="fa-solid fa-xmark text-xs"></i>';
                    cancelBtn.onclick = cancelEditingRole;

                    container.appendChild(input); container.appendChild(saveBtn); container.appendChild(cancelBtn);
                    settingsRoleList.appendChild(container);
                    setTimeout(() => input.focus(), 50);
                } else {
                    // Display Mode
                    const isActive = roleKey === currentSettingsRole;
                    const displayName = roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
                    
                    const container = document.createElement('div');
                    container.className = `group flex items-center justify-between px-3 py-2 rounded-lg border mb-2 transition-all cursor-pointer ${isActive ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:shadow-sm'}`;
                    container.onclick = () => switchSettingsRole(roleKey);

                    const span = document.createElement('span');
                    span.className = 'flex-1 text-sm font-medium truncate select-none';
                    span.textContent = displayName;
                    container.appendChild(span);

                    const actionDiv = document.createElement('div');
                    actionDiv.className = `flex gap-1 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity`;
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = `p-1.5 rounded transition-colors ${isActive ? 'text-indigo-100 hover:bg-indigo-500' : 'text-slate-400 hover:bg-slate-100 hover:text-indigo-600'}`;
                    editBtn.innerHTML = '<i class="fa-solid fa-pen text-xs"></i>';
                    editBtn.onclick = (e) => { e.stopPropagation(); startEditingRole(roleKey); };

                    const delBtn = document.createElement('button');
                    delBtn.className = `p-1.5 rounded transition-colors ${isActive ? 'text-indigo-100 hover:bg-indigo-500 hover:text-red-200' : 'text-slate-400 hover:bg-slate-100 hover:text-red-500'}`;
                    delBtn.innerHTML = '<i class="fa-solid fa-trash-can text-xs"></i>';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteItem(roleKey, 'role'); };

                    actionDiv.appendChild(editBtn); actionDiv.appendChild(delBtn);
                    container.appendChild(actionDiv);
                    settingsRoleList.appendChild(container);
                }
            });
        }

        function renderRoleRadios(containerId, inputName, onChangeFunctionStr) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = '';

            Object.keys(rolePermissions).forEach(roleKey => {
                const displayName = roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
                const label = document.createElement('label');
                label.className = "cursor-pointer relative";
                label.innerHTML = `
                    <input type="radio" name="${inputName}" value="${displayName}" onchange="window.${onChangeFunctionStr}('${roleKey}')" class="peer sr-only">
                    <div class="p-2 border rounded bg-white hover:bg-slate-50 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-700 text-center transition-all">
                        <div class="text-xs font-bold truncate">${displayName}</div>
                    </div>
                `;
                container.appendChild(label);
            });
        }

        function renderAllRoleUIs() {
            renderSettingsSidebar();
            renderRoleRadios('mainRoleGrid', 'role', 'applyRole');
            renderRoleRadios('editRoleGrid', 'editRole', 'applyEditRole');
        }

        renderAllRoleUIs();

        // --- TOGGLE LOGIC UPDATED FOR MANDATORY ---
        window.toggleAll = function(checked, clearRoles = true) {
            document.querySelectorAll('input[name="permissions"]').forEach(cb => {
                if(!cb.disabled) cb.checked = checked; // Only toggle enabled ones
            });
            if(!checked && clearRoles) {
                document.querySelectorAll('input[name="role"]').forEach(r => r.checked = false);
            }
        }

        window.toggleEditAll = function(checked) {
            document.querySelectorAll('input[name="editPermissions"]').forEach(cb => {
                if(!cb.disabled) cb.checked = checked; 
            });
        }

        window.toggleSettingsAll = function(checked) {
            document.querySelectorAll('input[name="settingsPermissions"]').forEach(cb => {
                if(!cb.disabled) cb.checked = checked; 
            });
        }

        window.applyRole = function(roleName) {
            window.toggleAll(false, false); 
            const checkboxes = document.querySelectorAll('input[name="permissions"]');
            let targetIds = rolePermissions[roleName] === 'all' ? menuItems.map(m => m.id) : rolePermissions[roleName] || [];

            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                // Mandatory Logic: Always check mandatory items
                const item = menuItems.find(m => m.id === id);
                if (item && item.mandatory) {
                    cb.checked = true;
                } else if (targetIds.includes(id)) {
                    cb.checked = true;
                }
            });
        }

        window.applyEditRole = function(roleName) {
            window.toggleEditAll(false); 
            const checkboxes = document.querySelectorAll('input[name="editPermissions"]');
            let targetIds = rolePermissions[roleName] === 'all' ? menuItems.map(m => m.id) : rolePermissions[roleName] || [];

            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                const item = menuItems.find(m => m.id === id);
                if (item && item.mandatory) {
                    cb.checked = true;
                } else if (targetIds.includes(id)) {
                    cb.checked = true;
                }
            });
        } 

        // --- ROLE SETTINGS LOGIC ---
        window.openRoleSettingsModal = function() {
            roleSettingsModal.classList.remove('hidden');
            const roles = Object.keys(rolePermissions);
            if(roles.length > 0 && !rolePermissions[currentSettingsRole]) {
                currentSettingsRole = roles[0];
            }
            if(roles.length > 0) {
                switchSettingsRole(currentSettingsRole); 
            } else {
                renderSettingsSidebar();
            }
        }

        window.closeRoleSettingsModal = function() {
            roleSettingsModal.classList.add('hidden');
            cancelEditingRole(); 
        }

        window.switchSettingsRole = function(roleName) {
            currentSettingsRole = roleName;
            
            const title = roleName.charAt(0).toUpperCase() + roleName.slice(1);
            const titleEl = document.getElementById('currentRoleTitle');
            if(titleEl) titleEl.textContent = `Editing: ${title}`;

            renderSettingsSidebar();

            const checkboxes = document.querySelectorAll('input[name="settingsPermissions"]');
            let targetIds = rolePermissions[roleName] === 'all' ? menuItems.map(m => m.id) : rolePermissions[roleName] || [];

            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                const item = menuItems.find(m => m.id === id);
                if (item && item.mandatory) {
                    cb.checked = true;
                    cb.disabled = true; // Lock mandatory in settings
                } else {
                    cb.checked = targetIds.includes(id);
                    cb.disabled = false; 
                }
            });
        }

        function startEditingRole(roleKey) {
            editingRoleKey = roleKey;
            renderSettingsSidebar();
        }

        function cancelEditingRole() {
            editingRoleKey = null;
            renderSettingsSidebar();
        }

        function saveEditedRole(oldKey) {
            const input = document.getElementById('editRoleInput');
            if(!input) return;
            
            const newName = input.value.trim();
            if (newName === "") {
                alert("กรุณาระบุชื่อบทบาท");
                input.focus();
                return;
            }

            const newKey = newName.toLowerCase().replace(/\s+/g, '_');

            if (newKey !== oldKey && rolePermissions[newKey]) {
                alert("ชื่อบทบาทนี้มีอยู่แล้ว");
                input.focus();
                return;
            }

            if (newKey !== oldKey) {
                const permissions = rolePermissions[oldKey];
                rolePermissions[newKey] = permissions;
                delete rolePermissions[oldKey];
                
                if (currentSettingsRole === oldKey) {
                    currentSettingsRole = newKey;
                    const title = newKey.charAt(0).toUpperCase() + newKey.slice(1);
                    const titleEl = document.getElementById('currentRoleTitle');
                    if(titleEl) titleEl.textContent = `Editing: ${title}`;
                }
            }

            editingRoleKey = null;
            saveRolesToFirebase();
            renderAllRoleUIs(); 
        }

        window.addNewRole = function() {
            const input = document.getElementById('newRoleNameInput');
            const roleName = input.value.trim();
            
            if (!roleName) {
                alert('กรุณาระบุชื่อบทบาท');
                return;
            }
            
            const roleKey = roleName.toLowerCase().replace(/\s+/g, '_');
            
            if (rolePermissions[roleKey]) {
                alert('ชื่อบทบาทนี้มีอยู่แล้ว');
                return;
            }

            // Default permissions for new role: ALL MANDATORY ITEMS
            rolePermissions[roleKey] = menuItems.filter(m => m.mandatory).map(m => m.id);
            input.value = '';
            
            saveRolesToFirebase();
            renderAllRoleUIs();
            switchSettingsRole(roleKey);
        }

        // --- MENU MANAGER LOGIC ---
        window.openMenuSettingsModal = function() {
            menuSettingsModal.classList.remove('hidden');
            updateParentOptions(); // Update Dropdown
            renderMenuManagerTable();
        }

        window.closeMenuSettingsModal = function() {
            menuSettingsModal.classList.add('hidden');
            editingMenuId = null;
        }

        // Helper: Generate Parent Options
        function updateParentOptions(selectedId = null) {
            const select = document.getElementById('newMenuParent');
            if(!select) return;
            
            // Keep first option
            select.innerHTML = '<option value="">- เป็นเมนูหลัก -</option>';
            
            // Filter only main headers
            const headers = menuItems.filter(m => m.type === 'header').sort((a,b) => a.id - b.id);
            
            headers.forEach(h => {
                const option = document.createElement('option');
                option.value = h.id;
                option.textContent = h.name;
                if(selectedId && h.id == selectedId) option.selected = true;
                select.appendChild(option);
            });
            
            toggleMandatoryCheck();
        }

        // Logic: Allow toggle required for all types (Except hardcoded logic for existing Dashboard)
        window.toggleMandatoryCheck = function() {
            const parentSelect = document.getElementById('newMenuParent');
            const mandatoryCheck = document.getElementById('newMenuMandatory');
            const mandatoryContainer = document.getElementById('newMenuMandatoryContainer');
            
            // Unlock all by default for new items
            mandatoryCheck.disabled = false;
            mandatoryContainer.classList.remove('opacity-50');
            mandatoryContainer.title = "";
        }

        function renderMenuManagerTable() {
            menuManagerTable.innerHTML = '';
            
            // Use sorted list for display
            const displayItems = getSortedMenuItems();

            displayItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0";
                
                // Editing Row
                if (item.id === editingMenuId) {
                    tr.classList.add('bg-indigo-50');
                    
                    // Build Parent Options for Edit Row
                    let parentOptions = '<option value="">- เมนูหลัก -</option>';
                    menuItems.filter(m => m.type === 'header' && m.id !== item.id).forEach(h => {
                        const sel = item.parentId === h.id ? 'selected' : '';
                        parentOptions += `<option value="${h.id}" ${sel}>${h.name}</option>`;
                    });

                    // Logic for mandatory check based on ID (Dashboard 15 is always locked)
                    const isDashboard = item.id === 15;
                    const mandatoryDisabled = isDashboard ? 'disabled' : '';
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3">
                            <input type="number" id="editMenuIdInput-${item.id}" value="${item.id}" class="w-full px-2 py-1 text-xs border border-indigo-300 rounded outline-none text-center bg-white text-slate-700 focus:ring-1 focus:ring-indigo-500" ${isDashboard ? 'disabled' : ''}>
                        </td>
                        <td class="px-4 py-3">
                            <input type="text" id="editMenuNameInput-${item.id}" value="${item.name}" class="w-full px-2 py-1 text-xs border border-indigo-300 rounded outline-none">
                        </td>
                         <td class="px-4 py-3">
                            <select id="editMenuParentInput-${item.id}" class="w-full px-2 py-1 text-xs border border-indigo-300 rounded outline-none">
                                ${parentOptions}
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                             <input type="checkbox" id="editMenuMandatoryInput-${item.id}" ${item.mandatory ? 'checked' : ''} ${mandatoryDisabled} class="w-4 h-4 text-indigo-600 rounded">
                        </td>
                        <td class="px-4 py-3 text-right">
                             <button onclick="saveEditedMenu(${item.id})" class="text-white bg-green-500 hover:bg-green-600 p-1.5 rounded mr-1 shadow-sm"><i class="fa-solid fa-check"></i></button>
                             <button onclick="cancelEditMenu()" class="text-slate-500 hover:bg-slate-200 p-1.5 rounded"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    `;
                } else {
                    // Normal Row
                    const isMain = item.type === 'header';
                    const parentName = item.parentId 
                        ? (menuItems.find(m => m.id === item.parentId)?.name || 'Unknown') 
                        : '<span class="text-indigo-400 font-bold">Main Menu</span>';
                    
                    const nameStyle = isMain ? "font-bold text-slate-800" : "text-slate-600 pl-4 border-l-2 border-indigo-100 ml-2";

                    // Allow delete if not Dashboard
                    const isDashboard = item.id === 15;
                    const deleteBtn = isDashboard 
                        ? `<span class="text-slate-300 p-1.5"><i class="fa-solid fa-lock text-xs"></i></span>`
                        : `<button onclick="deleteItem(${item.id}, 'menu')" class="text-red-400 hover:bg-red-50 p-1.5 rounded transition-colors"><i class="fa-solid fa-trash-can"></i></button>`;

                    tr.innerHTML = `
                        <td class="px-4 py-3 text-center text-slate-500 text-xs font-mono">${item.id}</td>
                        <td class="px-4 py-3">
                            <span class="${nameStyle}">${item.name}</span>
                        </td>
                        <td class="px-4 py-3 text-xs text-slate-500">
                             ${parentName}
                        </td>
                        <td class="px-4 py-3 text-center">
                             ${item.mandatory 
                                ? '<span class="inline-flex items-center justify-center w-5 h-5 bg-emerald-100 text-emerald-600 rounded-full"><i class="fa-solid fa-check text-[10px]"></i></span>' 
                                : '<span class="text-slate-300">-</span>'}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="startEditMenu(${item.id})" class="text-indigo-400 hover:bg-indigo-50 p-1.5 rounded transition-colors mr-1"><i class="fa-solid fa-pen"></i></button>
                            ${deleteBtn}
                        </td>
                    `;
                }
                menuManagerTable.appendChild(tr);
            });
        }

        window.addNewMenu = function() {
            const idInput = document.getElementById('newMenuId');
            const nameInput = document.getElementById('newMenuName');
            const parentSelect = document.getElementById('newMenuParent');
            const mandatoryInput = document.getElementById('newMenuMandatory');
            
            const name = nameInput.value.trim();
            if (!name) { alert("กรุณาระบุชื่อเมนู"); return; }

            // Handle ID
            let newId = parseInt(idInput.value);
            if (!newId) {
                newId = menuItems.length > 0 ? Math.max(...menuItems.map(m => m.id)) + 1 : 1;
            } else {
                if (menuItems.some(m => m.id === newId)) {
                    alert(`ID ${newId} มีอยู่แล้ว กรุณาใช้ ID อื่น`);
                    return;
                }
            }

            // Handle Type & Parent
            const parentId = parentSelect.value ? parseInt(parentSelect.value) : null;
            const type = parentId ? 'item' : 'header';
            
            // Allow manual setting of mandatory
            const isMandatory = mandatoryInput.checked;
            
            menuItems.push({ 
                id: newId, 
                name: name, 
                type: type, 
                parentId: parentId, 
                mandatory: isMandatory 
            });
            
            saveMenusToFirebase();
            
            // Reset & Refresh
            nameInput.value = '';
            idInput.value = '';
            mandatoryInput.checked = false;
            updateParentOptions(); // Refresh dropdown for next add
        }

        window.startEditMenu = function(id) {
            editingMenuId = id;
            renderMenuManagerTable();
            setTimeout(() => {
                const input = document.getElementById(`editMenuNameInput-${id}`);
                if(input) input.focus();
            }, 50);
        }

        window.cancelEditMenu = function() {
            editingMenuId = null;
            renderMenuManagerTable();
        }

        window.saveEditedMenu = function(originalId) {
            const idInput = document.getElementById(`editMenuIdInput-${originalId}`);
            const nameInput = document.getElementById(`editMenuNameInput-${originalId}`);
            const parentInput = document.getElementById(`editMenuParentInput-${originalId}`);
            const mandatoryInput = document.getElementById(`editMenuMandatoryInput-${originalId}`);
            
            if(!nameInput || !idInput) return;
            
            const newName = nameInput.value.trim();
            const newId = parseInt(idInput.value);
            const parentId = parentInput.value ? parseInt(parentInput.value) : null;
            
            if(!newName) return;
            if(!newId) { alert("ID ห้ามว่าง"); return; }

            if (newId !== originalId && menuItems.some(m => m.id === newId)) {
                alert(`ID ${newId} มีอยู่แล้ว ไม่สามารถเปลี่ยนได้`);
                return;
            }

            const index = menuItems.findIndex(m => m.id === originalId);
            if(index !== -1) {
                // Determine Type based on parent
                const type = parentId ? 'item' : 'header';
                
                // Dashboard is ALWAYS mandatory
                let isMandatory = mandatoryInput.checked;
                if(originalId === 15) isMandatory = true;

                // Update
                menuItems[index].name = newName;
                menuItems[index].type = type;
                menuItems[index].parentId = parentId;
                menuItems[index].mandatory = isMandatory;
                
                // If ID changed
                if (newId !== originalId) {
                    menuItems[index].id = newId;
                    // Update children parentIds if this was a parent
                    menuItems.forEach(child => {
                        if (child.parentId === originalId) {
                            child.parentId = newId;
                        }
                    });
                    
                    // Update Roles
                    let rolesUpdated = false;
                    Object.keys(rolePermissions).forEach(roleKey => {
                        const perms = rolePermissions[roleKey];
                        if (Array.isArray(perms) && perms.includes(originalId)) {
                            const permIndex = perms.indexOf(originalId);
                            perms[permIndex] = newId;
                            rolesUpdated = true;
                        }
                    });
                    if (rolesUpdated) saveRolesToFirebase();
                }
                
                saveMenusToFirebase();
                editingMenuId = null;
                updateParentOptions(); // Refresh dropdowns
            }
        }

        // --- UNIFIED DELETE LOGIC ---
        window.deleteItem = function(keyOrId, type) {
            itemToDelete = keyOrId;
            deleteType = type;
            
            let displayName = '';
            if (type === 'role') {
                displayName = keyOrId.charAt(0).toUpperCase() + keyOrId.slice(1);
            } else if (type === 'menu') {
                const item = menuItems.find(m => m.id === keyOrId);
                displayName = item ? item.name : 'Unknown';
            } else if (type === 'adminUser') {
                 const user = adminUsersList.find(u => u.id === keyOrId);
                 displayName = user ? user.username : 'Unknown';
            }

            const displayEl = document.getElementById('deleteItemNameDisplay');
            if(displayEl) displayEl.textContent = displayName;
            
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
            
            // Rebind execute button to generic function
            const btn = document.getElementById('btnConfirmDelete');
            if(btn) btn.onclick = executeDelete;
        }

        window.closeDeleteConfirmModal = function() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            itemToDelete = null;
            deleteType = null;
        }

        function executeDelete() {
            if (!itemToDelete || !deleteType) return;
            
            if (deleteType === 'role') {
                executeDeleteRole(itemToDelete);
            } else if (deleteType === 'menu') {
                executeDeleteMenu(itemToDelete);
            } else if (deleteType === 'adminUser') {
                executeDeleteAdminUser(itemToDelete);
            }
        }

        function executeDeleteRole(roleKey) {
            delete rolePermissions[roleKey];
            
            if (currentSettingsRole === roleKey) {
                const remainingRoles = Object.keys(rolePermissions);
                if (remainingRoles.length > 0) {
                    switchSettingsRole(remainingRoles[0]);
                } else {
                    currentSettingsRole = '';
                    document.getElementById('currentRoleTitle').textContent = 'No Role Selected';
                    renderSettingsSidebar();
                    document.querySelectorAll('input[name="settingsPermissions"]').forEach(cb => {
                        cb.checked = false;
                        cb.disabled = true;
                    });
                }
            } else {
                renderSettingsSidebar();
            }
            
            saveRolesToFirebase();
            renderAllRoleUIs();
            window.closeDeleteConfirmModal();
        }

        function executeDeleteMenu(menuId) {
            menuItems = menuItems.filter(m => m.id !== menuId);
            
            Object.keys(rolePermissions).forEach(key => {
                 if (Array.isArray(rolePermissions[key])) {
                     rolePermissions[key] = rolePermissions[key].filter(id => id !== menuId);
                 }
            });
            saveRolesToFirebase(); 
            saveMenusToFirebase(); 
            
            window.closeDeleteConfirmModal();
        }

        function executeDeleteAdminUser(userId) {
            deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'admin_users', userId))
                .then(() => {
                     window.closeDeleteConfirmModal();
                })
                .catch(err => {
                    console.error("Error deleting user:", err);
                    alert("ไม่สามารถลบผู้ใช้งานได้");
                });
        }

        // --- OLDER LOGIC ---
        window.saveRoleSettings = function() {
            if(!currentSettingsRole || !rolePermissions[currentSettingsRole]) {
                alert("กรุณาเลือกหรือสร้าง Role ก่อนบันทึก");
                return;
            }

            const checkboxes = document.querySelectorAll('input[name="settingsPermissions"]:checked');
            let selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            // Force include mandatory items
            menuItems.forEach(m => {
                if(m.mandatory && !selectedIds.includes(m.id)) {
                    selectedIds.push(m.id);
                }
            });
            
            if(selectedIds.length === menuItems.length) {
                rolePermissions[currentSettingsRole] = 'all';
            } else {
                rolePermissions[currentSettingsRole] = selectedIds;
            }

            // SAVE TO FIREBASE
            saveRolesToFirebase();

            const saveBtn = document.getElementById('btnSaveRoleSettings');
            if (!saveBtn) return;

            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = `<i class="fa-solid fa-check"></i> บันทึกแล้ว`;
            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            
            setTimeout(() => {
                saveBtn.innerHTML = originalContent;
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }, 1500);
        }

        window.addToQueue = function() {
            const nameInput = document.getElementById('inputName');
            const name = nameInput.value.trim();
            const email = document.getElementById('inputEmail').value.trim();
            const merchantId = document.querySelector('input[name="merchantId"]').value.trim();
            
            if (!merchantId) { alert('กรุณาระบุรหัสร้านค้า (Merchant ID)'); return; }
            if (!name || !email) { alert('กรุณากรอกข้อมูลผู้ใช้งานให้ครบ (Username, อีเมล)'); return; }

            // --- Check Duplicate ---
            const isDuplicate = userQueue.some(u => u.fullName.toLowerCase() === name.toLowerCase());
            
            if (isDuplicate) {
                alert(`Username "${name}" มีอยู่ในรายการที่รอส่งแล้ว กรุณาตรวจสอบอีกครั้ง`);
                nameInput.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                nameInput.focus();
                
                nameInput.addEventListener('input', function() {
                    this.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                }, { once: true });
                
                return;
            }
            // -------------------------------------------

            let role = 'Custom';
            const roleRadio = document.querySelector('input[name="role"]:checked');
            if (roleRadio) role = roleRadio.value;

            let permissions = [];
            document.querySelectorAll('input[name="permissions"]:checked').forEach(cb => {
                permissions.push(parseInt(cb.value));
            });
            
            // --- Apply Logic: If Parent Selected but No Children, Remove Parent (Main Menu = 0) ---
            permissions = cleanPermissions(permissions);

            const user = {
                tempId: Date.now(),
                fullName: name,
                email: email,
                role: role,
                permissionCount: permissions.length,
                permissions: permissions
            };

            userQueue.push(user);
            renderQueue();
            
            document.getElementById('inputName').value = '';
            document.getElementById('inputEmail').value = '';
            document.getElementById('inputName').focus();
            
            // Re-apply mandatory checks
            menuItems.forEach(m => {
                if(m.mandatory) {
                    const cb = document.querySelector(`input[name="permissions"][value="${m.id}"]`);
                    if(cb) cb.checked = true;
                }
            });
        }

        window.removeFromQueue = function(tempId) {
            userQueue = userQueue.filter(u => u.tempId !== tempId);
            renderQueue();
        }

        window.editQueueItem = function(tempId) {
            const item = userQueue.find(u => u.tempId === tempId);
            if (!item) return;

            document.getElementById('inputName').value = item.fullName;
            document.getElementById('inputEmail').value = item.email;

            const roleRadios = document.querySelectorAll('input[name="role"]');
            let roleFound = false;
            roleRadios.forEach(r => {
                if (r.value === item.role) {
                    r.checked = true;
                    roleFound = true;
                } else {
                    r.checked = false;
                }
            });

            const checkboxes = document.querySelectorAll('input[name="permissions"]');
            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                const menu = menuItems.find(m => m.id === id);
                if (menu && menu.mandatory) {
                    cb.checked = true;
                } else {
                    cb.checked = item.permissions.includes(id);
                }
            });

            window.removeFromQueue(tempId);

            document.getElementById('inputName').focus();
            document.getElementById('userInputSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            const formBox = document.getElementById('userInputSection');
            formBox.classList.add('ring-2', 'ring-indigo-400', 'bg-indigo-50');
            setTimeout(() => {
                formBox.classList.remove('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                formBox.classList.add('bg-indigo-50/30');
            }, 1000);
        }

        function renderQueue() {
            if(queueCountDisplay) queueCountDisplay.textContent = userQueue.length;
            if(footerCount) footerCount.textContent = userQueue.length;
            if(nextUserIndex) nextUserIndex.textContent = userQueue.length + 1;
            
            if (userQueue.length > 0) {
                if(queueSection) queueSection.classList.remove('hidden');
                if(submitAllBtn) {
                    submitAllBtn.disabled = false;
                    submitAllBtn.innerHTML = `<span>ยืนยันทั้งหมด (${userQueue.length})</span> <i class="fa-solid fa-paper-plane text-sm"></i>`;
                }
            } else {
                if(queueSection) queueSection.classList.add('hidden');
                if(submitAllBtn) {
                    submitAllBtn.disabled = true;
                    submitAllBtn.innerHTML = `<span>ยืนยันทั้งหมด</span> <i class="fa-solid fa-paper-plane text-sm"></i>`;
                }
            }

            if(queueListBody) {
                queueListBody.innerHTML = '';
                userQueue.forEach((u, index) => {
                    const tr = document.createElement('tr');
                    const isLast = index === userQueue.length - 1;
                    const highlightClass = isLast ? 'highlight-row' : '';
                    
                    tr.className = `user-card-enter ${highlightClass} bg-white hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0`;
                    tr.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="font-medium text-slate-800">${u.fullName}</div>
                            <div class="text-xs text-slate-400">${u.email}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-block px-2 py-0.5 rounded text-xs border bg-slate-100 text-slate-600 border-slate-200">
                                ${u.role}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-xs text-slate-500">
                            ${u.permissionCount} เมนู
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="editQueueItem(${u.tempId})" class="text-indigo-400 hover:text-indigo-600 p-1.5 hover:bg-indigo-50 rounded transition-colors" title="แก้ไข">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="removeFromQueue(${u.tempId})" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded transition-colors" title="ลบ">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    queueListBody.appendChild(tr);
                });
            }
        }

        requestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (userQueue.length === 0) return;
            window.openPreviewModal();
        });

        window.openPreviewModal = function() {
            const merchantId = document.querySelector('input[name="merchantId"]').value;
            const merchantName = document.querySelector('input[name="merchantName"]').value || '-';
            
            document.getElementById('previewMerchantId').textContent = merchantId;
            document.getElementById('previewMerchantName').textContent = merchantName;
            document.getElementById('previewUserCount').textContent = userQueue.length;

            const previewUserList = document.getElementById('previewUserList');
            previewUserList.innerHTML = '';
            
            // Sort items for display
            const displayItems = getSortedMenuItems();
            
            userQueue.forEach((u, index) => {
                let permListHTML = '<div class="grid grid-cols-1 gap-0 bg-slate-50 p-4 rounded-lg border border-slate-100 max-h-64 overflow-y-auto">';
                
                // Apply permission logic for display (Ensure Main=0 if no sub selected)
                const displayPermissions = cleanPermissions(u.permissions);

                displayItems.forEach((item, idx) => {
                    const isSelected = displayPermissions.includes(item.id);
                    const val = isSelected ? 1 : 0;
                    const rowBg = idx % 2 === 0 ? 'bg-white' : ''; // Alternate stripes
                    
                    let nameClass = isSelected ? 'text-slate-700 font-medium' : 'text-slate-400';
                    let indentClass = '';
                    
                    if (item.type === 'header') {
                        nameClass += ' font-bold';
                        // Add icon for Main Menu
                        if(isSelected) nameClass += ' text-indigo-700';
                    } else if (item.parentId) {
                        indentClass = 'pl-6 border-l-2 border-slate-100 ml-1.5';
                    }

                    const valClass = isSelected ? 'text-green-600 font-bold bg-green-50 border-green-200' : 'text-slate-300 bg-slate-100 border-slate-200';
                    const icon = isSelected && item.type === 'header' ? '<i class="fa-solid fa-folder-open mr-1.5 text-indigo-400"></i>' : '';
                    
                    permListHTML += `
                        <div class="flex justify-between items-center text-[11px] border-b border-slate-100 py-1.5 px-2 ${rowBg} rounded-sm">
                            <span class="${nameClass} ${indentClass} flex items-center">${icon}${item.name}</span>
                            <span class="px-2 py-0.5 rounded border ${valClass} min-w-[24px] text-center">${val}</span>
                        </div>
                    `;
                });
                permListHTML += '</div>';

                let roleClass = "bg-slate-100 text-slate-600";
                if(u.role === 'Manager') roleClass = "bg-indigo-100 text-indigo-700";
                if(u.role === 'Accounting') roleClass = "bg-emerald-100 text-emerald-700";
                if(u.role === 'IT') roleClass = "bg-blue-100 text-blue-700";

                const card = document.createElement('div');
                card.className = "bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b border-slate-100 pb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${u.fullName}</div>
                                <div class="text-xs text-slate-500 flex gap-2">
                                    <span><i class="fa-regular fa-envelope"></i> ${u.email}</span>
                                </div>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-bold ${roleClass}">${u.role}</span>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-[10px] uppercase text-slate-400 font-bold">Requested Permissions Matrix</div>
                            <div class="text-[10px] text-slate-400"><span class="font-bold text-green-600">1</span> = Selected, <span class="font-bold text-slate-400">0</span> = No</div>
                        </div>
                        ${permListHTML}
                    </div>
                `;
                previewUserList.appendChild(card);
            });

            previewModal.classList.remove('hidden');
        }

        window.closePreviewModal = function() {
            previewModal.classList.add('hidden');
        }

        window.confirmSubmission = function() {
            const merchantId = document.querySelector('input[name="merchantId"]').value;
            const merchantName = document.querySelector('input[name="merchantName"]').value || '-';
            const batchId = 'B-' + Date.now(); 

            const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
            const originalBtn = confirmSubmitBtn.innerHTML;
            confirmSubmitBtn.disabled = true;
            confirmSubmitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังส่งข้อมูล...';

            // Use Promise.all to add requests in parallel
            const promises = userQueue.map(u => {
                const req = {
                    batchId: batchId,
                    date: new Date().toLocaleDateString('th-TH'),
                    merchantId: merchantId,
                    merchantName: merchantName,
                    fullName: u.fullName,
                    email: u.email,
                    role: u.role,
                    permissionCount: u.permissionCount,
                    permissions: u.permissions,
                    status: 'pending',
                    createdAt: serverTimestamp()
                };
                return addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'merchant_requests'), req);
            });

            Promise.all(promises).then(() => {
                // --- SEND GOOGLE CHAT NOTIFICATION ---
                const webhookUrl = "https://chat.googleapis.com/v1/spaces/AAQA0QTVPFg/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=dHj9gDo1s98VBrlE_3yDJWzAlO9j2-lP51XEfr27OMw";
                
                const messageText = 
                    `📢 *มีการขอสร้าง User ใหม่ (Merchant Request)*\n` +
                    `🏢 *ร้านค้า:* ${merchantId} - ${merchantName}\n` +
                    `👥 *จำนวน:* ${userQueue.length} คน\n` +
                    `🆔 *Batch ID:* ${batchId}\n` +
                    `📅 *วันที่:* ${new Date().toLocaleDateString('th-TH')}`;

                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8'
                    },
                    body: JSON.stringify({ text: messageText })
                }).catch(err => console.error("Error sending notification:", err));
                // -------------------------------------

                window.closePreviewModal();
                
                const successMessageEl = document.getElementById('successMessage');
                if(successMessageEl) {
                    successMessageEl.classList.remove('hidden');
                    successMessageEl.classList.add('flex');
                }

                userQueue = [];
                renderQueue();
                
                confirmSubmitBtn.disabled = false;
                confirmSubmitBtn.innerHTML = originalBtn;
                
                updateStats();
            }).catch(err => {
                console.error("Error submitting", err);
                confirmSubmitBtn.disabled = false;
                confirmSubmitBtn.innerHTML = originalBtn;
                alert('เกิดข้อผิดพลาดในการส่งข้อมูล');
            });
        }

        window.resetAll = function() {
            userQueue = [];
            renderQueue();
            requestForm.reset();
            const successMessageEl = document.getElementById('successMessage');
            if(successMessageEl) {
                successMessageEl.classList.add('hidden');
                successMessageEl.classList.remove('flex');
            }
            window.toggleAll(false, true);
            
            const dashCheck = document.querySelector('input[name="permissions"][value="15"]');
            if(dashCheck) dashCheck.checked = true;
        }

        const userView = document.getElementById('userView');
        const adminView = document.getElementById('adminView');
        const btnUserView = document.getElementById('btnUserView');
        const btnAdminView = document.getElementById('btnAdminView');
        const requestTableBody = document.getElementById('requestTableBody');
        const pendingCountEl = document.getElementById('pendingCount');
        const approvedCountEl = document.getElementById('approvedCount');
        const emptyState = document.getElementById('emptyState');

        // Override toggleView logic for Login
        window.toggleView = function(viewName) {
            if (viewName === 'admin') {
                if (isAdminLoggedIn) {
                    showAdminView();
                } else {
                    document.getElementById('adminLoginModal').classList.remove('hidden');
                }
            } else {
                // *** เพิ่ม Logic: ถ้าล็อกอินอยู่ ให้ Logout ทันทีเมื่อจะกลับไปหน้า User Form ***
                if (isAdminLoggedIn) {
                    handleLogout(); // เรียกฟังก์ชัน Logout ซึ่งจะเคลียร์ Session และเรียก toggleView('user') อีกครั้ง
                    return;
                }

                // Show User View
                adminView.classList.add('hidden');
                adminView.classList.remove('flex');
                userView.classList.remove('hidden');
                
                btnUserView.classList.add('hidden');
                btnAdminView.classList.remove('hidden');
            }
        }

        function showAdminView() {
            userView.classList.add('hidden');
            adminView.classList.remove('hidden');
            adminView.classList.add('flex');
            
            btnAdminView.classList.add('hidden');
            btnUserView.classList.remove('hidden');
            
            // Toggle Admin Tools based on Role
            const adminTools = document.getElementById('adminTools');
            if (currentUserRole === 'sale') {
                adminTools.classList.add('hidden');
            } else {
                adminTools.classList.remove('hidden');
            }
            
            renderAdminTable();
        }

        // Login Handler
        window.handleAdminLogin = function(e) {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            
            // 1. Check DB first
            const dbUser = adminUsersList.find(user => user.username === u && user.password === p);

            if (dbUser) {
                loginSuccess(dbUser);
                return;
            }

            // 2. Fallback to hardcoded defaults (if DB empty or failed)
            const defaultUser = defaultAdminUsers.find(user => user.username === u && user.password === p);
            if (defaultUser) {
                loginSuccess(defaultUser);
                return;
            }

            // Failed
            document.getElementById('loginError').classList.remove('hidden');
        }

        function loginSuccess(user) {
            isAdminLoggedIn = true;
            currentUserRole = user.role; 
            
            // REMOVED: Saving to LocalStorage
            // localStorage.setItem('merchant_admin_session', ...);
            
            closeLoginModal();
            showAdminView();
            
            // Clear fields
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
            
            // Show User Badge
            updateUserBadge(user.role);
        }
        
        function updateUserBadge(role) {
            const badge = document.getElementById('currentUserBadge');
            if (badge) {
                badge.textContent = role.toUpperCase();
                badge.classList.remove('hidden');
                if (role === 'sale') {
                    badge.classList.remove('bg-indigo-500');
                    badge.classList.add('bg-orange-500');
                } else {
                    badge.classList.remove('bg-orange-500');
                    badge.classList.add('bg-indigo-500');
                }
            }
        }

        window.closeLoginModal = function() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
        }

        window.handleLogout = function() {
            isAdminLoggedIn = false;
            currentUserRole = null;
            // REMOVED: localStorage.removeItem('merchant_admin_session');
            window.toggleView('user');
        }

        window.searchRequests = function() {
            renderAdminTable();
        }

        function renderAdminTable() {
            if(!requestTableBody) return;
            requestTableBody.innerHTML = '';

            // Filter logic
            const searchTerm = document.getElementById('adminSearchInput') ? document.getElementById('adminSearchInput').value.toLowerCase() : '';
            
            const filteredRequests = requests.filter(req => {
                if (!searchTerm) return true;
                return (
                    (req.merchantId && req.merchantId.toLowerCase().includes(searchTerm)) ||
                    (req.merchantName && req.merchantName.toLowerCase().includes(searchTerm)) ||
                    (req.batchId && req.batchId.toLowerCase().includes(searchTerm)) ||
                    (req.fullName && req.fullName.toLowerCase().includes(searchTerm))
                );
            });

            if (filteredRequests.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden'); 
                return;
            } else {
                if(emptyState) emptyState.classList.add('hidden');
            }

            const batches = {};
            filteredRequests.forEach(req => {
                if (!batches[req.batchId]) {
                    batches[req.batchId] = {
                        batchId: req.batchId,
                        date: req.date,
                        merchantId: req.merchantId,
                        merchantName: req.merchantName,
                        totalUsers: 0,
                        pendingUsers: 0,
                        approvedUsers: 0,
                        rejectedUsers: 0,
                        users: [] 
                    };
                }
                batches[req.batchId].totalUsers++;
                if(req.status === 'pending') batches[req.batchId].pendingUsers++;
                if(req.status === 'approved') batches[req.batchId].approvedUsers++;
                if(req.status === 'rejected') batches[req.batchId].rejectedUsers++;
                batches[req.batchId].users.push(req);
            });

            // Sort batches by date (newest first) implicitly by how requests are sorted or explicitly here if needed
            // Object.values doesn't guarantee order, but usually fine. For strict order:
            const sortedBatches = Object.values(batches).sort((a, b) => {
                 // Simple date string compare might fail if format is DD/MM/YYYY
                 // Assuming requests already sorted from query, so simple reverse or just iterate
                 return 0; 
            });

            sortedBatches.forEach(batch => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0';
                
                let statusBadge = '';
                if (batch.pendingUsers > 0) {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><span class="w-1.5 h-1.5 mr-1.5 bg-yellow-400 rounded-full"></span>รออนุมัติ (${batch.pendingUsers})</span>`;
                } else if (batch.rejectedUsers > 0 && batch.approvedUsers === 0) {
                     statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">ปฏิเสธทั้งหมด</span>`;
                } else {
                    statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">อนุมัติครบถ้วน</span>`;
                }

                tr.innerHTML = `
                    <td class="p-4 text-slate-500">${batch.date}</td>
                    <td class="p-4">
                        <div class="font-medium text-slate-800">${batch.merchantId}</div>
                        <div class="text-xs text-slate-500">${batch.merchantName}</div>
                        <div class="text-[10px] text-slate-400 mt-1">Ref: ${batch.batchId}</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="font-bold text-slate-700">${batch.totalUsers}</span> <span class="text-xs text-slate-400">คน</span>
                    </td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-right">
                        <button onclick="openDetailModal('${batch.batchId}')" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i> ดูรายละเอียด
                        </button>
                    </td>
                `;
                requestTableBody.appendChild(tr);
            });
            
            updateStats();
        }

        function getPermissionNamesHTML(permissionIds) {
            const selectedIds = permissionIds || [];
            let html = '<div class="flex flex-col gap-0">';
            
            // Sort items for display hierarchy
            const displayItems = getSortedMenuItems();

            displayItems.forEach((item, index) => {
                const isSelected = selectedIds.includes(item.id);
                const value = isSelected ? 1 : 0;
                const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50';
                
                // Styling for Hierarchy
                let nameStyle = isSelected ? 'text-slate-700 font-medium' : 'text-slate-400';
                let indentStyle = '';
                
                if (item.type === 'header') {
                    nameStyle += ' font-bold';
                } else if (item.parentId) {
                    indentStyle = 'pl-4 border-l-2 border-slate-100 ml-1';
                }

                const valClass = isSelected ? 'text-green-600 font-bold' : 'text-slate-300';
                
                html += `
                    <div class="flex justify-between items-center py-1 px-2 ${bgClass} border-b border-slate-100 last:border-0 text-[11px]">
                        <span class="${nameStyle} ${indentStyle}">${item.name}</span>
                        <span class="${valClass}">${value}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        window.openDetailModal = function(batchId) {
            currentModalBatchId = batchId; 
            const batchUsers = requests.filter(r => r.batchId === batchId);
            if(batchUsers.length === 0) return;

            const first = batchUsers[0];
            modalMerchantName.textContent = `${first.merchantId} - ${first.merchantName}`;
            modalBatchId.textContent = `Batch ID: ${batchId} | Date: ${first.date}`;

            modalTableBody.innerHTML = '';
            batchUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 border-b border-slate-100 align-top';

                let statusBadge = '';
                let actions = '';
                
                // Conditional Actions based on Role
                if (currentUserRole === 'sale') {
                     // SALE VIEW: Read Only
                    if (u.status === 'pending') {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-700">รออนุมัติ</span>`;
                        actions = `<span class="text-xs text-slate-400 italic">View Only</span>`;
                    } else if (u.status === 'approved') {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700">อนุมัติแล้ว</span>`;
                        actions = `<span class="text-xs text-green-600">Approved</span>`;
                    } else {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-700">ปฏิเสธ</span>`;
                        actions = `<span class="text-xs text-red-600">Rejected</span>`;
                    }
                } else {
                    // ADMIN VIEW: Full Control
                    if (u.status === 'pending') {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-700">รออนุมัติ</span>`;
                        actions = `
                            <button onclick="editUser('${u.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded" title="แก้ไข"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="updateUserStatus('${u.id}', 'approved', '${batchId}')" class="p-2 text-green-600 hover:bg-green-50 rounded" title="อนุมัติ"><i class="fa-solid fa-check"></i></button>
                            <button onclick="updateUserStatus('${u.id}', 'rejected', '${batchId}')" class="p-2 text-red-600 hover:bg-red-50 rounded" title="ปฏิเสธ"><i class="fa-solid fa-xmark"></i></button>
                        `;
                    } else if (u.status === 'approved') {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-700">อนุมัติแล้ว</span>`;
                        actions = `<span class="text-xs text-slate-300">Success</span>`;
                    } else {
                        statusBadge = `<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-700">ปฏิเสธ</span>`;
                        actions = `<span class="text-xs text-slate-300">Rejected</span>`;
                    }
                }

                let roleColor = "bg-slate-100 text-slate-600";
                if(u.role === 'Manager') roleColor = "bg-indigo-50 text-indigo-700 border border-indigo-100";
                if(u.role === 'Accounting') roleColor = "bg-emerald-50 text-emerald-700 border border-emerald-100";
                if(u.role === 'IT') roleColor = "bg-blue-50 text-blue-700 border border-blue-100";

                const permListHTML = getPermissionNamesHTML(u.permissions);

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-800">${u.fullName}</div>
                        <div class="text-xs text-slate-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-medium ${roleColor}">${u.role}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col items-start gap-1">
                            <span class="text-xs font-bold text-slate-700">${u.permissionCount} เมนู</span>
                            <button id="perm-btn-${u.id}" onclick="togglePerms('${u.id}')" class="text-[10px] text-indigo-600 hover:text-indigo-800 underline cursor-pointer">แสดงรายการ</button>
                            <div id="perm-list-${u.id}" class="hidden mt-2 p-0 bg-slate-50 rounded border border-slate-200 max-h-64 overflow-y-auto w-full transition-all">
                                ${permListHTML}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-1">${actions}</div>
                    </td>
                `;
                modalTableBody.appendChild(tr);
            });

            detailModal.classList.remove('hidden');
        }

        window.closeDetailModal = function() {
            detailModal.classList.add('hidden');
            currentModalBatchId = null;
        }

        window.togglePerms = function(id) {
            const el = document.getElementById(`perm-list-${id}`);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // --- EDIT USER LOGIC ---
        window.editUser = function(id) {
            const user = requests.find(r => r.id === id);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.fullName;
            document.getElementById('editEmail').value = user.email;

            const roleRadios = document.querySelectorAll('input[name="editRole"]');
            let roleFound = false;
            roleRadios.forEach(r => {
                if (r.value === user.role) {
                    r.checked = true;
                    roleFound = true;
                }
            });
            if(!roleFound) {
                roleRadios.forEach(r => r.checked = false);
            }

            const editCheckboxes = document.querySelectorAll('input[name="editPermissions"]');
            editCheckboxes.forEach(cb => {
                const pid = parseInt(cb.value);
                // Just use raw values for checkboxes, let save handle logic
                cb.checked = user.permissions.includes(pid);
                
                // Re-apply mandatory visual disable
                const item = menuItems.find(m => m.id === pid);
                if (item && item.mandatory) {
                    cb.checked = true;
                }
            });

            editUserModal.classList.remove('hidden');
        }

        window.closeEditModal = function() {
            editUserModal.classList.add('hidden');
        }

        window.saveUserChanges = function() {
            const id = document.getElementById('editUserId').value;
            const originalUser = requests.find(r => r.id === id);
            
            if (originalUser) {
                // Get role
                let role = 'Custom';
                const roleRadio = document.querySelector('input[name="editRole"]:checked');
                if (roleRadio) role = roleRadio.value;

                let permissions = [];
                document.querySelectorAll('input[name="editPermissions"]:checked').forEach(cb => {
                    permissions.push(parseInt(cb.value));
                });
                
                // Apply cleaning logic
                permissions = cleanPermissions(permissions);
                
                const updates = {
                    fullName: document.getElementById('editName').value,
                    email: document.getElementById('editEmail').value,
                    role: role,
                    permissions: permissions,
                    permissionCount: permissions.length
                };

                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'merchant_requests', id), updates).then(() => {
                    window.closeEditModal();
                    window.openDetailModal(originalUser.batchId);
                });
            }
        }

        window.exportBatchExcel = function() {
            if (!currentModalBatchId) return;
            
            const batchUsers = requests.filter(r => r.batchId === currentModalBatchId);
            if (batchUsers.length === 0) {
                alert("ไม่พบข้อมูลสำหรับ Export");
                return;
            }

            const first = batchUsers[0];
            const dateStr = first.date.replace(/\//g, '-'); 
            
            // Sort items for Excel report hierarchy
            const displayItems = getSortedMenuItems();

            // Pre-process users to apply cleanPermissions logic (No Sub = No Main)
            const processedUsers = batchUsers.map(u => ({
                ...u,
                permissions: cleanPermissions(u.permissions || [])
            }));

            let html = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <!--[if gte mso 9]>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Permissions Report</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <![endif]-->
                    <style>
                        body { font-family: 'Kanit', sans-serif; }
                        table { border-collapse: collapse; width: 100%; }
                        td, th { border: 1px solid #cbd5e1; padding: 10px; text-align: left; vertical-align: middle; }
                        .header-main { background-color: #4338ca; color: white; font-size: 18px; font-weight: bold; text-align: center; height: 50px; }
                        .header-section { background-color: #e0e7ff; color: #3730a3; font-weight: bold; font-size: 14px; }
                        .header-col { background-color: #f1f5f9; font-weight: bold; color: #475569; }
                        .label { font-weight: bold; background-color: #f8fafc; width: 250px; }
                        .value { background-color: #ffffff; }
                        .check-yes { background-color: #dcfce7; color: #166534; text-align: center; font-weight: bold; border: 1px solid #86efac; }
                        .check-no { background-color: #f8fafc; color: #94a3b8; text-align: center; }
                        .text-center { text-align: center; }
                        .indent { text-indent: 20px; }
                    </style>
                </head>
                <body>
                    <table>
                        <tr>
                            <td colspan="${processedUsers.length + 1}" class="header-main">
                                Merchant User Request Report
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Batch ID</td>
                            <td colspan="${processedUsers.length}" class="value" style="mso-number-format:'\@'">${first.batchId}</td>
                        </tr>
                        <tr>
                            <td class="label">Date</td>
                            <td colspan="${processedUsers.length}" class="value">${first.date}</td>
                        </tr>
                        <tr>
                            <td class="label">Merchant</td>
                            <td colspan="${processedUsers.length}" class="value" style="font-weight:bold;">[${first.merchantId}] ${first.merchantName}</td>
                        </tr>
                        <tr>
                            <td class="label">Total Users</td>
                            <td colspan="${processedUsers.length}" class="value">${processedUsers.length} Persons</td>
                        </tr>
                        <tr style="height: 20px;"><td colspan="${processedUsers.length + 1}"></td></tr>
                        
                        <tr class="header-section">
                            <td class="text-center">User Information</td>
                            ${processedUsers.map((u, i) => `<td class="text-center" style="width:150px;">User ${i + 1}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="label">Full Name</td>
                            ${processedUsers.map(u => `<td>${u.fullName}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="label">Role</td>
                            ${processedUsers.map(u => `<td>${u.role}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="label">Email</td>
                            ${processedUsers.map(u => `<td>${u.email}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="label">Phone</td>
                            ${processedUsers.map(u => `<td style="mso-number-format:'\@'">${u.phone || '-'}</td>`).join('')}
                        </tr>
                        
                        <tr style="height: 20px;"><td colspan="${processedUsers.length + 1}"></td></tr>

                        <tr class="header-section">
                            <td>Permissions Matrix (${displayItems.length} Menus)</td>
                            ${processedUsers.map(u => `<td class="text-center">${u.fullName}</td>`).join('')}
                        </tr>
            `;

            displayItems.forEach(item => {
                const indentClass = item.parentId ? 'indent' : '';
                const prefix = item.parentId ? '↳ ' : '';
                const style = item.type === 'header' ? 'font-weight:bold; background-color:#f8fafc;' : '';
                
                html += `<tr><td class="header-col ${indentClass}" style="${style}">${prefix}${item.name}</td>`;
                
                processedUsers.forEach(u => {
                    const isSelected = u.permissions.includes(item.id);
                    if (isSelected) {
                        html += `<td class="check-yes">1</td>`;
                    } else {
                        html += `<td class="check-no">0</td>`;
                    }
                });
                html += `</tr>`;
            });

            html += `
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `Report_${first.merchantId}_${dateStr}.xls`;
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
        }

        window.updateUserStatus = function(id, newStatus, currentBatchId) {
            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'merchant_requests', id), {
                status: newStatus
            }).then(() => {
                window.openDetailModal(currentBatchId);
            });
        };

        function updateStats() {
            const pending = requests.filter(r => r.status === 'pending').length;
            const approved = requests.filter(r => r.status === 'approved').length;
            if(pendingCountEl) pendingCountEl.textContent = pending;
            if(approvedCountEl) approvedCountEl.textContent = approved;
        }

    </script>
</body>
</html>